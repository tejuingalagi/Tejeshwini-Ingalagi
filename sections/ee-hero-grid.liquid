{% comment %} EE Product Grid Section with Popup & Add to Cart {% endcomment %}

<section class="ee-product-grid">
  <div class="grid-wrapper">
    {% for product in section.settings.products %}
      <div class="grid-item">
        <img src="{{ product.featured_image | image_url: width: 400 }}" alt="{{ product.title }}">
        <h3>{{ product.title }}</h3>
        <p>{{ product.price | money }}</p>
        <button class="quick-view-btn" 
                data-product-id="{{ product.id }}">Quick View</button>
      </div>
    {% endfor %}
  </div>
</section>

<!-- Popup -->
<div id="product-popup" class="popup-overlay">
  <div class="popup-content">
    <span class="close-btn">&times;</span>
    <h2 id="popup-title"></h2>
    <img id="popup-image" src="" alt="">
    <p id="popup-price"></p>
    <p id="popup-description"></p>
    <select id="popup-variant"></select>
    <button id="popup-add-to-cart">Add to Cart</button>
  </div>
</div>

{% schema %}
{
  "name": "EE Product Grid",
  "settings": [
    {
      "type": "product_list",
      "id": "products",
      "label": "Select 6 products",
      "limit": 6
    }
  ]
}
{% endschema %}

<style>
.ee-product-grid .grid-wrapper {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap:20px;
}
.grid-item {
  border:1px solid #eee;
  padding:10px;
  text-align:center;
}
.grid-item img {
  width:100%;
  border-radius:8px;
}
.quick-view-btn {
  margin-top:10px;
  padding:10px 15px;
  background:#ff0000;
  color:#fff;
  border:none;
  cursor:pointer;
  transition: transform 0.3s ease;
}
.quick-view-btn:hover {
  transform: translateY(-2px);
}

/* Popup */
.popup-overlay {
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background: rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.popup-content {
  background:#fff;
  padding:20px;
  max-width:500px;
  width:90%;
  border-radius:10px;
  text-align:center;
  position:relative;
}
.close-btn {
  position:absolute;
  top:10px;right:15px;
  font-size:24px;
  cursor:pointer;
}
#popup-image {
  max-width:100%;
  margin-bottom:15px;
}
#popup-variant {
  margin:15px 0;
  padding:8px;
  width:100%;
}
#popup-add-to-cart {
  padding:12px 25px;
  background:#ff0000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
@media(max-width:768px){
  .ee-product-grid .grid-wrapper{
    grid-template-columns: repeat(2,1fr);
  }
}
@media(max-width:480px){
  .ee-product-grid .grid-wrapper{
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const popup = document.getElementById("product-popup");
  const closeBtn = document.querySelector(".close-btn");
  const variantSelect = document.getElementById("popup-variant");
  const addToCartBtn = document.getElementById("popup-add-to-cart");

  document.querySelectorAll(".quick-view-btn").forEach(btn => {
    btn.addEventListener("click", async function(){
      const productId = this.dataset.productId;
      const res = await fetch(`/products/${productId}.js`);
      const product = await res.json();

      document.getElementById("popup-title").textContent = product.title;
      document.getElementById("popup-image").src = product.images[0];
      document.getElementById("popup-price").textContent = Shopify.formatMoney(product.price);
      document.getElementById("popup-description").textContent = product.description;

      variantSelect.innerHTML = '';
      product.variants.forEach(v => {
        const option = document.createElement('option');
        option.value = v.id;
        option.textContent = v.title;
        variantSelect.appendChild(option);
      });

      popup.style.display = "flex";

      // Auto-add "Soft Winter Jacket" if variant is Black + Medium
      addToCartBtn.onclick = async function(){
        const selectedVariant = variantSelect.value;
        await fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:selectedVariant, quantity:1}) });
        const selectedText = variantSelect.options[variantSelect.selectedIndex].text;
        if(selectedText.includes('Black') && selectedText.includes('Medium')){
          // Assuming Soft Winter Jacket ID is known
          await fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:123456789, quantity:1}) });
        }
        alert('Product added to cart!');
        popup.style.display = "none";
      };
    });
  });

  closeBtn.addEventListener("click", ()=> popup.style.display="none");
  window.addEventListener("click", e => { if(e.target===popup) popup.style.display="none"; });
});
</script>
